<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äºŒå¹´çº§è¯­æ–‡å¬å†™</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- ResponsiveVoiceåº“ -->
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=PU84uNRT"></script>
    <style>
        /* ä¿æŒåŸæœ‰æ ·å¼ï¼Œåªä¿®æ”¹å…³é”®éƒ¨åˆ† */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", STHeiti, "Microsoft YaHei", sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            min-height: 100vh;
            padding: 12px;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* è¯­éŸ³çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .voice-status {
            background: #e8f5e9;
            border-radius: 12px;
            padding: 12px 15px;
            margin-bottom: 15px;
            border: 2px solid #4caf50;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            color: #2e7d32;
            font-weight: 600;
        }

        .voice-status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .voice-status-ios {
            background: #e3f2fd;
            color: #1565c0;
        }

        .voice-status-android {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜... */
        /* è¿™é‡Œçœç•¥é‡å¤çš„æ ·å¼ï¼Œä¿æŒä¹‹å‰çš„æ ·å¼ä¸å˜ */
        .header, .settings, .buttons-row, .progress-container, .words-container {
            /* ä¿æŒåŸæœ‰æ ·å¼ */
        }

        /* å®‰å“ä¸“ç”¨æç¤º */
        .android-tip {
            background: #fff3e0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #ff9800;
            display: none;
        }

        .android-tip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            color: #e65100;
            font-weight: 600;
        }

        .android-tip-content {
            font-size: 13px;
            color: #e65100;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- è¯­éŸ³çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="voice-status" id="voiceStatus">
            <div class="voice-status-item">
                <i class="fas fa-mobile-alt"></i>
                <span id="deviceType">æ£€æµ‹è®¾å¤‡ä¸­...</span>
            </div>
            <div class="voice-status-item">
                <i class="fas fa-volume-up"></i>
                <span id="voiceEngine">è¯­éŸ³å¼•æ“: æ£€æµ‹ä¸­...</span>
            </div>
        </div>

        <!-- å®‰å“ä¸“ç”¨æç¤º -->
        <div class="android-tip" id="androidTip">
            <div class="android-tip-header">
                <i class="fas fa-android"></i>
                <span>å®‰å“æ‰‹æœºç”¨æˆ·è¯·æ³¨æ„</span>
            </div>
            <div class="android-tip-content">
                å¦‚æœè¯­éŸ³åŠŸèƒ½ä¸æ­£å¸¸ï¼Œè¯·ï¼š<br>
                1. ä½¿ç”¨Chromeæµè§ˆå™¨ï¼ˆä¸è¦ç”¨å¾®ä¿¡å†…ç½®æµè§ˆå™¨ï¼‰<br>
                2. ç¡®ä¿æ‰‹æœºéŸ³é‡å·²æ‰“å¼€<br>
                3. ç‚¹å‡»ä¸‹æ–¹"æµ‹è¯•è¯­éŸ³"ç¡®ä¿åŠŸèƒ½æ­£å¸¸
            </div>
        </div>

        <!-- å¤´éƒ¨æ ‡é¢˜ -->
        <div class="header">
            <div class="title">
                <i class="fas fa-book-open"></i>
                <span id="pageTitle">äºŒå¹´çº§è¯­æ–‡å¬å†™</span>
                <i class="fas fa-pencil-alt"></i>
            </div>
            <div class="subtitle">å…¨å¹³å°å…¼å®¹ç‰ˆ Â· ç‚¹å‡»å¼€å§‹å¬å†™</div>
        </div>

        <!-- è®¾ç½®åŒºåŸŸ -->
        <div class="settings">
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-label">
                        <i class="fas fa-list-ol"></i>
                        <span>æ•°é‡</span>
                    </div>
                    <div class="setting-control">
                        <input type="number" class="number-input" id="wordCount" min="5" max="30" value="10">
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <i class="fas fa-redo-alt"></i>
                        <span>éæ•°</span>
                    </div>
                    <div class="setting-control">
                        <select class="select-input" id="readTimes">
                            <option value="1">1é</option>
                            <option value="2" selected>2é</option>
                            <option value="3">3é</option>
                        </select>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-label">
                        <i class="fas fa-clock"></i>
                        <span>é—´éš”</span>
                    </div>
                    <div class="setting-control">
                        <select class="select-input" id="intervalTime">
                            <option value="3">3ç§’</option>
                            <option value="4" selected>4ç§’</option>
                            <option value="5">5ç§’</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- æŒ‰é’®ç»„ -->
            <div class="buttons-row">
                <button class="btn btn-primary" id="startBtn" disabled>
                    <i class="fas fa-play-circle"></i>
                    <span>å¼€å§‹</span>
                </button>
                <button class="btn btn-secondary" id="pauseBtn" disabled>
                    <i class="fas fa-pause-circle"></i>
                    <span>æš‚åœ</span>
                </button>
                <button class="btn btn-warning" id="showAnswerBtn">
                    <i class="fas fa-check-circle"></i>
                    <span>ç­”æ¡ˆ</span>
                </button>
                <button class="btn btn-success" id="resetBtn">
                    <i class="fas fa-redo"></i>
                    <span>é‡ç½®</span>
                </button>
            </div>
        </div>

        <!-- æµ‹è¯•æŒ‰é’® -->
        <div class="buttons-row" style="margin-top: 10px;">
            <button class="btn" id="testVoiceBtn" style="background: #9575cd; color: white;">
                <i class="fas fa-volume-up"></i>
                <span>æµ‹è¯•è¯­éŸ³</span>
            </button>
        </div>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-container">
            <div class="progress-label">
                <span>å¬å†™è¿›åº¦</span>
                <span id="progressText">0/0</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- è¯è¯­æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="words-container">
            <div class="words-grid" id="wordsGrid">
                <div style="text-align: center; color: #9fa8da; padding: 30px 15px;">
                    <i class="fas fa-spell-check" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                    <div style="font-size: 16px; font-weight: 500;">è¯·å…ˆæµ‹è¯•è¯­éŸ³åŠŸèƒ½</div>
                    <div style="font-size: 12px; margin-top: 5px;">ç‚¹å‡»"æµ‹è¯•è¯­éŸ³"ç¡®ä¿åŠŸèƒ½æ­£å¸¸</div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨ä¿¡æ¯ -->
        <div class="footer">
            <div>äºŒå¹´çº§ä¸Šå†Œè¯­æ–‡å¬å†™ç»ƒä¹ </div>
            <div style="margin-top: 3px; font-size: 11px;">æ”¯æŒiOS/å®‰å“/å¾®ä¿¡ Â· æ¨èä½¿ç”¨Chromeæµè§ˆå™¨</div>
        </div>
    </div>

    <script>
        // ========== æ ¸å¿ƒé…ç½®ï¼šäºŒå¹´çº§ä¸Šå†Œç²¾é€‰è¯è¯­åº“ ==========
        const wordLibrary = [
            { pinyin: "mÄ ma", word: "å¦ˆå¦ˆ" },
            { pinyin: "bÃ  ba", word: "çˆ¸çˆ¸" },
            { pinyin: "wÇ’ men", word: "æˆ‘ä»¬" },
            { pinyin: "tÄ men", word: "ä»–ä»¬" },
            // ... ä¿æŒåŸæœ‰çš„è¯è¯­åº“æ•°æ®
        ];

        // ========== å…¨å±€å˜é‡ ==========
        let selectedWords = [];
        let currentWordIndex = 0;
        let currentReadTimes = 0;
        let timer = null;
        let isPaused = false;
        let isDictationRunning = false;
        let voiceSupported = false;
        let voiceTested = false;
        let isAndroid = false;
        let currentVoiceEngine = 'auto'; // 'native', 'responsivevoice'

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        function initPage() {
            // è®¾ç½®é¡µé¢æ ‡é¢˜
            const now = new Date();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const weekDays = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
            const weekDay = weekDays[now.getDay()];
            document.getElementById("pageTitle").innerText = `${month}æœˆ${day}æ—¥ ${weekDay}`;
            
            // æ£€æµ‹è®¾å¤‡å’Œè¯­éŸ³æ”¯æŒ
            detectDeviceAndVoice();
            
            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
            initEvents();
        }

        // æ£€æµ‹è®¾å¤‡å’Œè¯­éŸ³æ”¯æŒ
        function detectDeviceAndVoice() {
            const ua = navigator.userAgent.toLowerCase();
            
            // æ£€æµ‹è®¾å¤‡ç±»å‹
            if (/android/.test(ua)) {
                isAndroid = true;
                document.getElementById("deviceType").textContent = "å®‰å“è®¾å¤‡";
                document.getElementById("androidTip").style.display = "block";
            } else if (/iphone|ipad|ipod/.test(ua)) {
                document.getElementById("deviceType").textContent = "iOSè®¾å¤‡";
            } else {
                document.getElementById("deviceType").textContent = "å…¶ä»–è®¾å¤‡";
            }
            
            // æ£€æµ‹è¯­éŸ³æ”¯æŒ
            if (typeof responsiveVoice !== 'undefined') {
                currentVoiceEngine = 'responsivevoice';
                document.getElementById("voiceEngine").textContent = "è¯­éŸ³å¼•æ“: ResponsiveVoice";
                voiceSupported = true;
            } else if ('speechSynthesis' in window) {
                currentVoiceEngine = 'native';
                document.getElementById("voiceEngine").textContent = "è¯­éŸ³å¼•æ“: åŸç”Ÿè¯­éŸ³";
                voiceSupported = true;
            } else {
                document.getElementById("voiceEngine").textContent = "è¯­éŸ³å¼•æ“: ä¸æ”¯æŒ";
                voiceSupported = false;
                showVoiceNotSupported();
            }
        }

        // æ˜¾ç¤ºè¯­éŸ³ä¸æ”¯æŒæç¤º
        function showVoiceNotSupported() {
            const alertMsg = `
                æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½ï¼Œè¯·å°è¯•ï¼š
                
                1. ä½¿ç”¨Chromeæµè§ˆå™¨ï¼ˆä¸è¦ç”¨å¾®ä¿¡å†…ç½®æµè§ˆå™¨ï¼‰
                2. ç¡®ä¿æ‰‹æœºç³»ç»ŸéŸ³é‡å·²æ‰“å¼€
                3. æ£€æŸ¥æµè§ˆå™¨æƒé™ï¼ˆå…è®¸è¯­éŸ³ï¼‰
                
                ç‚¹å‡»ç¡®å®šç»§ç»­ä½¿ç”¨æ‰‹åŠ¨æ¨¡å¼ï¼ˆéœ€è¦å®¶é•¿æœ—è¯»ï¼‰
            `;
            
            if (confirm(alertMsg)) {
                // å¯ç”¨æ‰‹åŠ¨æ¨¡å¼
                document.getElementById("startBtn").disabled = false;
                document.getElementById("startBtn").innerHTML = '<i class="fas fa-user"></i><span>æ‰‹åŠ¨æ¨¡å¼</span>';
                voiceSupported = false;
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEvents() {
            // æµ‹è¯•è¯­éŸ³æŒ‰é’®
            document.getElementById("testVoiceBtn").addEventListener("click", testVoiceFunction);
            
            // å¼€å§‹å¬å†™æŒ‰é’®
            document.getElementById("startBtn").addEventListener("click", startDictation);
            
            // æš‚åœæŒ‰é’®
            document.getElementById("pauseBtn").addEventListener("click", togglePause);
            
            // æ˜¾ç¤ºç­”æ¡ˆæŒ‰é’®
            document.getElementById("showAnswerBtn").addEventListener("click", showAnswer);
            
            // é‡ç½®æŒ‰é’®
            document.getElementById("resetBtn").addEventListener("click", resetDictation);
            
            // è¾“å…¥éªŒè¯
            document.getElementById("wordCount").addEventListener("change", function() {
                let value = parseInt(this.value);
                if (value < 5) this.value = 5;
                if (value > 30) this.value = 30;
            });
            
            // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
            document.addEventListener("visibilitychange", function() {
                if (document.hidden && isDictationRunning && !isPaused) {
                    togglePause();
                }
            });
        }

        // ========== è¯­éŸ³åŠŸèƒ½ï¼ˆè·¨æµè§ˆå™¨å…¼å®¹æ–¹æ¡ˆï¼‰==========
        
        // æµ‹è¯•è¯­éŸ³åŠŸèƒ½
        function testVoiceFunction() {
            const testBtn = document.getElementById("testVoiceBtn");
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>æµ‹è¯•ä¸­...</span>';
            testBtn.disabled = true;
            
            // æ¸…é™¤ä¹‹å‰çš„è¯­éŸ³
            stopAllSpeech();
            
            // ä½¿ç”¨å¤šç§æ–¹æ³•æµ‹è¯•è¯­éŸ³
            testVoiceWithFallback("æµ‹è¯•è¯­éŸ³åŠŸèƒ½").then(success => {
                if (success) {
                    voiceTested = true;
                    document.getElementById("startBtn").disabled = false;
                    
                    // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                    testBtn.innerHTML = '<i class="fas fa-check-circle"></i><span>æµ‹è¯•æˆåŠŸ</span>';
                    setTimeout(() => {
                        testBtn.innerHTML = '<i class="fas fa-volume-up"></i><span>æµ‹è¯•è¯­éŸ³</span>';
                        testBtn.disabled = false;
                    }, 2000);
                    
                    // æ›´æ–°è¯­éŸ³çŠ¶æ€æ˜¾ç¤º
                    const engineName = currentVoiceEngine === 'responsivevoice' ? 'ResponsiveVoice' : 'åŸç”Ÿè¯­éŸ³';
                    document.getElementById("voiceEngine").innerHTML = `<span style="color: #4caf50;">âœ“ è¯­éŸ³å¼•æ“: ${engineName} (æ­£å¸¸)</span>`;
                    
                } else {
                    // æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥
                    testBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>æµ‹è¯•å¤±è´¥</span>';
                    testBtn.disabled = false;
                    
                    showVoiceError();
                }
            });
        }

        // ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆæµ‹è¯•è¯­éŸ³
        function testVoiceWithFallback(text) {
            return new Promise((resolve) => {
                let success = false;
                let testedMethods = 0;
                const totalMethods = 2; // ä¸¤ç§æ–¹æ³•
                
                // æ–¹æ³•1: ä½¿ç”¨ResponsiveVoiceï¼ˆå¦‚æœå¯ç”¨ï¼‰
                if (typeof responsiveVoice !== 'undefined') {
                    responsiveVoice.speak(text, "Chinese Female", {
                        onend: function() {
                            success = true;
                            currentVoiceEngine = 'responsivevoice';
                            resolve(true);
                        },
                        onerror: function() {
                            testedMethods++;
                            if (testedMethods >= totalMethods) resolve(false);
                        }
                    });
                    
                    // è®¾ç½®è¶…æ—¶
                    setTimeout(() => {
                        testedMethods++;
                        if (testedMethods >= totalMethods && !success) resolve(false);
                    }, 3000);
                }
                
                // æ–¹æ³•2: ä½¿ç”¨åŸç”Ÿè¯­éŸ³åˆæˆ
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = "zh-CN";
                    utterance.volume = 1;
                    utterance.rate = 0.8;
                    utterance.pitch = 1.0;
                    
                    // å°è¯•ä½¿ç”¨ä¸­æ–‡è¯­éŸ³
                    const voices = speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        const chineseVoice = voices.find(v => v.lang.includes('zh') || v.lang.includes('CN'));
                        if (chineseVoice) utterance.voice = chineseVoice;
                    }
                    
                    utterance.onend = function() {
                        if (!success) {
                            success = true;
                            currentVoiceEngine = 'native';
                            resolve(true);
                        }
                    };
                    
                    utterance.onerror = function() {
                        testedMethods++;
                        if (testedMethods >= totalMethods && !success) resolve(false);
                    };
                    
                    speechSynthesis.speak(utterance);
                    
                    // è®¾ç½®è¶…æ—¶
                    setTimeout(() => {
                        testedMethods++;
                        if (testedMethods >= totalMethods && !success) resolve(false);
                    }, 3000);
                }
            });
        }

        // æœ—è¯»è¯è¯­ï¼ˆä¸»å‡½æ•°ï¼‰
        function speakWord(word) {
            return new Promise((resolve, reject) => {
                // æ ¹æ®å½“å‰é€‰æ‹©çš„å¼•æ“æœ—è¯»
                if (currentVoiceEngine === 'responsivevoice' && typeof responsiveVoice !== 'undefined') {
                    // ä½¿ç”¨ResponsiveVoice
                    responsiveVoice.speak(word, "Chinese Female", {
                        rate: 0.8,
                        pitch: 1,
                        volume: 1,
                        onend: resolve,
                        onerror: reject
                    });
                } else if ('speechSynthesis' in window) {
                    // ä½¿ç”¨åŸç”Ÿè¯­éŸ³åˆæˆ
                    const utterance = new SpeechSynthesisUtterance(word);
                    utterance.lang = "zh-CN";
                    utterance.volume = 1;
                    utterance.rate = 0.5;
                    utterance.pitch = 1.0;
                    
                    // è·å–ä¸­æ–‡è¯­éŸ³
                    const voices = speechSynthesis.getVoices();
                    if (voices.length > 0) {
                        const chineseVoice = voices.find(v => 
                            v.lang.includes('zh') || 
                            v.lang.includes('CN') || 
                            v.name.includes('Chinese')
                        );
                        if (chineseVoice) utterance.voice = chineseVoice;
                    }
                    
                    utterance.onend = resolve;
                    utterance.onerror = reject;
                    
                    speechSynthesis.speak(utterance);
                } else {
                    reject(new Error("No voice engine available"));
                }
            });
        }

        // åœæ­¢æ‰€æœ‰è¯­éŸ³
        function stopAllSpeech() {
            if (typeof responsiveVoice !== 'undefined') {
                responsiveVoice.cancel();
            }
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
        }

        // æ˜¾ç¤ºè¯­éŸ³é”™è¯¯
        function showVoiceError() {
            const errorMsg = `
                è¯­éŸ³åŠŸèƒ½æµ‹è¯•å¤±è´¥ï¼Œè¯·å°è¯•ä»¥ä¸‹æ­¥éª¤ï¼š
                
                ğŸ”§ å®‰å“æ‰‹æœºä¿®å¤æ­¥éª¤ï¼š
                1. ç‚¹å‡»å³ä¸Šè§’"..." â†’ "åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€"
                2. é€‰æ‹©"Chrome"æµè§ˆå™¨
                3. å…è®¸ç½‘é¡µä½¿ç”¨è¯­éŸ³åŠŸèƒ½
                4. é‡æ–°æµ‹è¯•
                
                ğŸ“± iOSæ‰‹æœºä¿®å¤æ­¥éª¤ï¼š
                1. ç¡®ä¿æ‰‹æœºæ²¡æœ‰é™éŸ³
                2. æ£€æŸ¥"è®¾ç½®-é€šç”¨-è¾…åŠ©åŠŸèƒ½-è¯­éŸ³å†…å®¹"æ˜¯å¦å¼€å¯
                
                ç‚¹å‡»ç¡®å®šä½¿ç”¨æ‰‹åŠ¨æ¨¡å¼ï¼ˆå®¶é•¿æœ—è¯»ï¼‰
            `;
            
            if (confirm(errorMsg)) {
                // å¯ç”¨æ‰‹åŠ¨æ¨¡å¼
                document.getElementById("startBtn").disabled = false;
                document.getElementById("startBtn").innerHTML = '<i class="fas fa-user"></i><span>æ‰‹åŠ¨æ¨¡å¼</span>';
                voiceSupported = false;
                voiceTested = true;
            }
        }

        // ========== æ ¸å¿ƒå¬å†™åŠŸèƒ½ ==========
        function startDictation() {
            if (isDictationRunning) return;
            
            if (!voiceSupported) {
                // æ‰‹åŠ¨æ¨¡å¼
                if (!confirm("æ‚¨å°†ä½¿ç”¨æ‰‹åŠ¨æ¨¡å¼ï¼Œéœ€è¦å®¶é•¿æ ¹æ®æ‹¼éŸ³æœ—è¯»è¯è¯­ã€‚ç¡®å®šå¼€å§‹å—ï¼Ÿ")) {
                    return;
                }
            } else if (!voiceTested) {
                alert("è¯·å…ˆæµ‹è¯•è¯­éŸ³åŠŸèƒ½ç¡®ä¿æ­£å¸¸å·¥ä½œ");
                return;
            }
            
            document.getElementById("startBtn").disabled = true;
            document.getElementById("pauseBtn").disabled = false;
            document.getElementById("showAnswerBtn").disabled = false;
            
            const wordCount = parseInt(document.getElementById("wordCount").value);
            const readTimes = parseInt(document.getElementById("readTimes").value);
            const interval = parseInt(document.getElementById("intervalTime").value) * 1000;
            
            if (isNaN(wordCount) || wordCount < 5 || wordCount > 30) {
                alert("è¯·é€‰æ‹©5-30ä¸ªè¯è¯­ï¼");
                document.getElementById("startBtn").disabled = false;
                document.getElementById("pauseBtn").disabled = true;
                return;
            }
            
            selectedWords = [];
            const tempLibrary = [...wordLibrary];
            const count = Math.min(wordCount, wordLibrary.length);
            
            for (let i = 0; i < count; i++) {
                const randomIndex = Math.floor(Math.random() * tempLibrary.length);
                selectedWords.push(tempLibrary[randomIndex]);
                tempLibrary.splice(randomIndex, 1);
            }
            
            renderWordsGrid();
            updateProgress();
            
            currentWordIndex = 0;
            currentReadTimes = 0;
            isPaused = false;
            isDictationRunning = true;
            
            playWord(interval, readTimes);
        }
        
        function renderWordsGrid() {
            const wordsGrid = document.getElementById("wordsGrid");
            wordsGrid.innerHTML = "";
            
            selectedWords.forEach((word, index) => {
                const wordCard = document.createElement("div");
                wordCard.className = "word-card";
                wordCard.innerHTML = `
                    <div class="pinyin">
                        <span>${word.pinyin}</span>
                        <i class="fas fa-volume-up" onclick="playSingleWord(${index})"></i>
                    </div>
                    <div class="character" id="character-${index}"></div>
                `;
                wordsGrid.appendChild(wordCard);
            });
        }
        
        function playWord(interval, readTimes) {
            if (isPaused) return;
            
            if (currentWordIndex >= selectedWords.length) {
                finishDictation();
                return;
            }
            
            const word = selectedWords[currentWordIndex].word;
            
            if (voiceSupported) {
                // è‡ªåŠ¨è¯­éŸ³æ¨¡å¼
                speakWord(word).then(() => {
                    // è¯­éŸ³æ’­æ”¾æˆåŠŸ
                    currentReadTimes++;
                    
                    if (currentReadTimes >= readTimes) {
                        currentWordIndex++;
                        currentReadTimes = 0;
                        updateProgress();
                    }
                    
                    timer = setTimeout(() => {
                        playWord(interval, readTimes);
                    }, interval);
                }).catch(error => {
                    console.error("è¯­éŸ³æ’­æ”¾å¤±è´¥:", error);
                    // æ’­æ”¾å¤±è´¥ï¼Œè·³è¿‡å½“å‰è¯è¯­
                    currentReadTimes = readTimes; // å¼ºåˆ¶å®Œæˆå½“å‰è¯
                    currentReadTimes++;
                    
                    if (currentReadTimes >= readTimes) {
                        currentWordIndex++;
                        currentReadTimes = 0;
                        updateProgress();
                    }
                    
                    timer = setTimeout(() => {
                        playWord(interval, readTimes);
                    }, interval);
                });
            } else {
                // æ‰‹åŠ¨æ¨¡å¼ - æ˜¾ç¤ºå½“å‰è¯è¯­ï¼Œç­‰å¾…å®¶é•¿æœ—è¯»
                alert(`è¯·æœ—è¯»ç¬¬${currentWordIndex + 1}ä¸ªè¯è¯­ï¼š${selectedWords[currentWordIndex].pinyin}`);
                
                currentReadTimes++;
                if (currentReadTimes >= readTimes) {
                    currentWordIndex++;
                    currentReadTimes = 0;
                    updateProgress();
                }
                
                timer = setTimeout(() => {
                    playWord(interval, readTimes);
                }, interval);
            }
        }
        
        function playSingleWord(index) {
            if (index >= 0 && index < selectedWords.length) {
                if (voiceSupported) {
                    speakWord(selectedWords[index].word);
                } else {
                    alert(`è¯·æœ—è¯»ï¼š${selectedWords[index].pinyin}`);
                }
            }
        }
        
        function togglePause() {
            if (!isDictationRunning) return;
            
            isPaused = !isPaused;
            const pauseBtn = document.getElementById("pauseBtn");
            
            if (isPaused) {
                pauseBtn.innerHTML = '<i class="fas fa-play-circle"></i><span>ç»§ç»­</span>';
                stopAllSpeech();
                clearTimeout(timer);
            } else {
                pauseBtn.innerHTML = '<i class="fas fa-pause-circle"></i><span>æš‚åœ</span>';
                const readTimes = parseInt(document.getElementById("readTimes").value);
                const interval = parseInt(document.getElementById("intervalTime").value) * 1000;
                
                setTimeout(() => {
                    playWord(interval, readTimes);
                }, 500);
            }
        }
        
        function finishDictation() {
            clearTimeout(timer);
            isDictationRunning = false;
            
            document.getElementById("startBtn").disabled = false;
            document.getElementById("pauseBtn").disabled = true;
            
            alert("å¬å†™å®Œæˆï¼ç‚¹å‡»ç­”æ¡ˆæŒ‰é’®æŸ¥çœ‹ç»“æœ");
            
            if (voiceSupported) {
                setTimeout(() => {
                    speakWord("å¬å†™å®Œæˆ");
                }, 300);
            }
        }
        
        function showAnswer() {
            selectedWords.forEach((word, index) => {
                const characterElement = document.getElementById(`character-${index}`);
                if (characterElement) {
                    characterElement.innerText = word.word;
                    characterElement.classList.add("answered");
                }
            });
            
            document.getElementById("showAnswerBtn").disabled = true;
        }
        
        function resetDictation() {
            clearTimeout(timer);
            stopAllSpeech();
            
            selectedWords = [];
            currentWordIndex = 0;
            currentReadTimes = 0;
            isPaused = false;
            isDictationRunning = false;
            
            document.getElementById("wordsGrid").innerHTML = `
                <div style="text-align: center; color: #9fa8da; padding: 30px 15px;">
                    <i class="fas fa-spell-check" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                    <div style="font-size: 16px; font-weight: 500;">ç‚¹å‡»"å¼€å§‹"æŒ‰é’®</div>
                    <div style="font-size: 12px; margin-top: 5px;">ç³»ç»Ÿå°†éšæœºé€‰å–è¯è¯­å¹¶æœ—è¯»</div>
                </div>
            `;
            
            document.getElementById("startBtn").disabled = !voiceTested;
            document.getElementById("pauseBtn").disabled = true;
            document.getElementById("pauseBtn").innerHTML = '<i class="fas fa-pause-circle"></i><span>æš‚åœ</span>';
            document.getElementById("showAnswerBtn").disabled = false;
            
            updateProgress();
        }
        
        function updateProgress() {
            const total = selectedWords.length;
            const current = currentWordIndex;
            const progress = total > 0 ? Math.round((current / total) * 100) : 0;
            
            document.getElementById("progressText").textContent = `${current}/${total}`;
            document.getElementById("progressFill").style.width = `${progress}%`;
        }
        
        // ========== é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ– ==========
        document.addEventListener("DOMContentLoaded", initPage);
        
        // iOSè¯­éŸ³åˆå§‹åŒ–
        if ('speechSynthesis' in window) {
            document.addEventListener('click', function initVoices() {
                if (speechSynthesis.getVoices().length === 0) {
                    const tempUtterance = new SpeechSynthesisUtterance('');
                    speechSynthesis.speak(tempUtterance);
                    speechSynthesis.cancel();
                }
                document.removeEventListener('click', initVoices);
            });
        }
    </script>
</body>
</html>